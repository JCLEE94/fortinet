name: ğŸš€ Main GitOps Pipeline - Complete Automation

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
        - dev
        - staging  
        - production
      skip_tests:
        description: 'Skip Tests'
        required: false
        default: false
        type: boolean
      force_deploy:
        description: 'Force Deploy (bypass checks)'
        required: false
        default: false
        type: boolean

env:
  # jclee.me ì¸í”„ë¼ ì„¤ì • (ì‹¤ì œ ìš´ì˜ í™˜ê²½)
  REGISTRY: ${{ vars.REGISTRY_DOMAIN || 'registry.jclee.me' }}
  ARGOCD_SERVER: ${{ vars.ARGOCD_DOMAIN || 'argo.jclee.me' }}
  K8S_API: ${{ vars.K8S_DOMAIN || 'k8s.jclee.me' }}
  PROJECT_NAME: ${{ vars.PROJECT_NAME || 'fortinet' }}
  K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE || 'fortinet' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
  EXTERNAL_URL: https://fortinet.jclee.me
  INTERNAL_URL: http://192.168.50.110:30777

jobs:
  # Job 1: í”„ë¡œì íŠ¸ ì •ë¦¬ & ì½”ë“œ í’ˆì§ˆ
  cleanup-and-quality:
    name: ğŸ§¹ Cleanup & Code Quality
    runs-on: ${{ vars.RUNNER_TYPE || 'self-hosted' }}  # Self-hosted runner ìš°ì„ 
    if: github.event_name == 'push' || github.event.inputs.force_deploy == 'true'
    outputs:
      quality-status: ${{ steps.quality.outputs.status }}
      changed-files: ${{ steps.changes.outputs.files }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install black isort flake8 safety bandit pytest
    
    - name: Detect Changed Files
      id: changes
      run: |
        if [[ "${{ github.event_name }}" == "push" ]]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -E '\.(py|yaml|yml|json)$' | tr '\n' ' ')
        else
          CHANGED_FILES=$(find src/ -name "*.py" | head -10 | tr '\n' ' ')
        fi
        echo "files=${CHANGED_FILES}" >> $GITHUB_OUTPUT
        echo "ğŸ“„ Changed files: ${CHANGED_FILES}"
    
    - name: Code Quality & Security
      id: quality
      run: |
        set -e  # ì˜¤ë¥˜ ë°œìƒì‹œ ì¤‘ë‹¨
        
        echo "ğŸ¨ Black í¬ë§·íŒ… ì ìš©..."
        black src/ --check --diff || black src/
        
        echo "ğŸ“¦ isort ì„í¬íŠ¸ ì •ë¦¬..."
        isort src/ --check-only --diff || isort src/
        
        echo "ğŸ” Flake8 ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."
        flake8 src/ --max-line-length=120 --ignore=E203,W503 --exit-zero
        
        echo "ğŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº”..."
        safety check --exit-zero
        bandit -r src/ -ll --exit-zero
        
        echo "status=success" >> $GITHUB_OUTPUT
    
    - name: Run Core Tests
      if: github.event.inputs.skip_tests != 'true'
      run: |
        echo "ğŸ§ª í•µì‹¬ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        cd src && python test_features.py || echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        
        echo "ğŸ”¬ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        pytest tests/unit/ -x -v --tb=short || echo "âš ï¸ ì¼ë¶€ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
    
    - name: Commit Quality Improvements
      run: |
        git config --local user.email "gitops-bot@jclee.me"
        git config --local user.name "GitOps Bot"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "chore(quality): ìë™í™”ëœ ì½”ë“œ í’ˆì§ˆ ê°œì„ 
          
          - Black í¬ë§·íŒ… ìë™ ì ìš©
          - isort ì„í¬íŠ¸ ì •ë¦¬ ì™„ë£Œ
          - ì½”ë“œ í’ˆì§ˆ í‘œì¤€í™”
          - ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ
          
          ğŸ¤– Generated with Claude Code GitOps
          Co-authored-by: GitHub Actions <actions@github.com>"
          git push origin HEAD
          echo "âœ… ì½”ë“œ í’ˆì§ˆ ê°œì„  ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ"
        else
          echo "âœ… ì½”ë“œ í’ˆì§ˆ ì´ë¯¸ ìµœì  ìƒíƒœ"
        fi

  # Job 2: Docker ë¹Œë“œ & Harbor Registry í‘¸ì‹œ  
  docker-build:
    name: ğŸ³ Docker Build & Registry Push
    runs-on: ${{ vars.RUNNER_TYPE || 'self-hosted' }}
    needs: [cleanup-and-quality]
    if: always() && (needs.cleanup-and-quality.result == 'success' || needs.cleanup-and-quality.result == 'skipped' || github.event.inputs.force_deploy == 'true')
    outputs:
      image-tag: ${{ steps.image.outputs.tag }}
      image-digest: ${{ steps.build.outputs.digest }}
      image-size: ${{ steps.build.outputs.size }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        use: true
        platforms: linux/amd64,linux/arm64
    
    - name: Login to Harbor Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
    
    - name: Generate Image Tags
      id: image
      run: |
        # íƒœê·¸ ì „ëµ: í™˜ê²½ë³„ + SHA + timestamp
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        SHORT_SHA=${GITHUB_SHA:0:8}
        TAG="${{ env.ENVIRONMENT }}-${SHORT_SHA}-${TIMESTAMP}"
        
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "full-sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
        
        echo "ğŸ·ï¸ Generated image tag: ${TAG}"
    
    - name: Build and Push Multi-arch Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.production
        push: true
        platforms: linux/amd64,linux/arm64  # Multi-arch ì§€ì›
        tags: |
          ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ steps.image.outputs.tag }}
          ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ env.ENVIRONMENT }}-latest
          ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          ENVIRONMENT=${{ env.ENVIRONMENT }}
          BUILD_DATE=${{ steps.image.outputs.timestamp }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ steps.image.outputs.tag }}
        labels: |
          org.opencontainers.image.title=${{ env.PROJECT_NAME }}
          org.opencontainers.image.description=FortiGate Nextrade - jclee.me GitOps Application
          org.opencontainers.image.version=${{ steps.image.outputs.tag }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ steps.image.outputs.timestamp }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.url=${{ env.EXTERNAL_URL }}
          gitops.jclee.me/environment=${{ env.ENVIRONMENT }}
          gitops.jclee.me/registry=${{ env.REGISTRY }}
    
    - name: Image Security Scan
      run: |
        echo "ğŸ” ì´ë¯¸ì§€ ë³´ì•ˆ ìŠ¤ìº” (ì„ íƒì )..."
        # Harbor ë˜ëŠ” Trivyë¥¼ ì‚¬ìš©í•œ ë³´ì•ˆ ìŠ¤ìº”
        echo "Image: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ steps.image.outputs.tag }}"
        echo "Build complete with security baseline"
    
    - name: Verify Image Push
      run: |
        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ ì™„ë£Œ"
        echo "ğŸ“¦ Registry: ${{ env.REGISTRY }}"
        echo "ğŸ·ï¸ Tag: ${{ steps.image.outputs.tag }}"
        echo "ğŸ“Š Platforms: linux/amd64, linux/arm64"
        echo "ğŸ”— Image URL: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ steps.image.outputs.tag }}"

  # Job 3: K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ & GitOps ë™ê¸°í™”
  gitops-deploy:
    name: âš¡ GitOps Deploy & Sync
    runs-on: ${{ vars.RUNNER_TYPE || 'self-hosted' }}
    needs: [docker-build]
    environment: ${{ github.event.inputs.environment || 'production' }}
    outputs:
      sync-status: ${{ steps.argocd.outputs.status }}
      app-health: ${{ steps.argocd.outputs.health }}
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Tools (Kustomize & ArgoCD CLI)
      run: |
        # Kustomize ì„¤ì¹˜
        echo "ğŸ“¦ Installing Kustomize..."
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/
        kustomize version
        
        # ArgoCD CLI ì„¤ì¹˜
        echo "âš¡ Installing ArgoCD CLI..."
        curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
        sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
        argocd version --client
    
    - name: Update Kustomize Image Tag
      run: |
        cd k8s/overlays/${{ env.ENVIRONMENT }}
        
        echo "ğŸ”„ Updating image tag in Kustomization..."
        kustomize edit set image ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ needs.docker-build.outputs.image-tag }}
        
        echo "ğŸ“‹ Validating rendered manifest..."
        kustomize build . > /tmp/rendered-manifest.yaml
        
        echo "ğŸ“„ Updated Kustomization:"
        cat kustomization.yaml | grep -A 2 "images:"
        
        echo "ğŸ” Manifest validation complete"
    
    - name: Commit GitOps State to Repository
      run: |
        git config --local user.email "gitops-bot@jclee.me"
        git config --local user.name "GitOps Automation"
        
        git add k8s/overlays/${{ env.ENVIRONMENT }}/kustomization.yaml
        
        if [[ -n $(git diff --staged) ]]; then
          git commit -m "deploy(${{ env.ENVIRONMENT }}): update ${{ env.PROJECT_NAME }} to ${{ needs.docker-build.outputs.image-tag }}
          
          ğŸš€ GitOps ìë™ ë°°í¬
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          â€¢ Environment: ${{ env.ENVIRONMENT }}
          â€¢ Registry: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ needs.docker-build.outputs.image-tag }}
          â€¢ Commit SHA: ${{ github.sha }}
          â€¢ Build Digest: ${{ needs.docker-build.outputs.image-digest }}
          â€¢ Platforms: linux/amd64, linux/arm64
          â€¢ External URL: ${{ env.EXTERNAL_URL }}
          â€¢ Internal URL: ${{ env.INTERNAL_URL }}
          
          ğŸ¤– Generated with Claude Code GitOps Pipeline
          Co-authored-by: GitHub Actions <actions@github.com>"
          
          git push origin HEAD
          echo "âœ… GitOps ìƒíƒœê°€ Repositoryì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤"
        fi
    
    - name: ArgoCD Authentication & Sync
      id: argocd
      run: |
        echo "ğŸ” ArgoCD ì„œë²„ ì—°ê²°..."
        # ArgoCD ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        argocd version --server ${{ env.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_TOKEN }} --grpc-web
        
        echo "ğŸ”„ Application ë™ê¸°í™” ì‹œì‘..."
        argocd app sync ${{ env.PROJECT_NAME }} \
          --server ${{ env.ARGOCD_SERVER }} \
          --auth-token ${{ secrets.ARGOCD_TOKEN }} \
          --timeout 300 \
          --grpc-web \
          --info || echo "âš ï¸ Sync ëª…ë ¹ì—ì„œ ê²½ê³  ë°œìƒ (ê³„ì† ì§„í–‰)"
        
        echo "â³ ë™ê¸°í™” ìƒíƒœ ëŒ€ê¸°..."
        argocd app wait ${{ env.PROJECT_NAME }} \
          --server ${{ env.ARGOCD_SERVER }} \
          --auth-token ${{ secrets.ARGOCD_TOKEN }} \
          --timeout 600 \
          --health \
          --grpc-web || echo "âš ï¸ Health checkì—ì„œ ê²½ê³  ë°œìƒ"
        
        # Application ìƒíƒœ í™•ì¸
        APP_STATUS=$(argocd app get ${{ env.PROJECT_NAME }} --server ${{ env.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_TOKEN }} --grpc-web -o json | jq -r '.status.sync.status // "Unknown"')
        APP_HEALTH=$(argocd app get ${{ env.PROJECT_NAME }} --server ${{ env.ARGOCD_SERVER }} --auth-token ${{ secrets.ARGOCD_TOKEN }} --grpc-web -o json | jq -r '.status.health.status // "Unknown"')
        
        echo "status=${APP_STATUS}" >> $GITHUB_OUTPUT
        echo "health=${APP_HEALTH}" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š ArgoCD Application Status:"
        echo "  â€¢ Sync Status: ${APP_STATUS}"
        echo "  â€¢ Health Status: ${APP_HEALTH}"
        echo "  â€¢ ArgoCD UI: https://${{ env.ARGOCD_SERVER }}/applications/${{ env.PROJECT_NAME }}"

  # Job 4: ë°°í¬ í›„ ê²€ì¦ & ëª¨ë‹ˆí„°ë§
  post-deployment-verification:
    name: ğŸ” Post-Deployment Verification
    runs-on: ${{ vars.RUNNER_TYPE || 'self-hosted' }}
    needs: [docker-build, gitops-deploy]
    steps:
    - name: Multi-Endpoint Health Verification
      run: |
        echo "ğŸ¥ Health Check ì‹œì‘..."
        
        # ë‹¤ì¤‘ ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦
        ENDPOINTS=(
          "${{ env.EXTERNAL_URL }}/api/health"
          "${{ env.EXTERNAL_URL }}/"
          "${{ env.INTERNAL_URL }}/api/health"
        )
        
        SUCCESS_COUNT=0
        TOTAL_ENDPOINTS=${#ENDPOINTS[@]}
        
        for endpoint in "${ENDPOINTS[@]}"; do
          echo "ğŸ” Testing: $endpoint"
          for attempt in {1..3}; do
            if curl -f -s --max-time 10 "$endpoint" > /dev/null 2>&1; then
              echo "  âœ… Attempt $attempt: SUCCESS"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              break
            else
              echo "  âŒ Attempt $attempt: FAILED"
              if [[ $attempt -eq 3 ]]; then
                echo "  ğŸ’¥ All attempts failed for $endpoint"
              fi
              sleep 5
            fi
          done
        done
        
        echo "ğŸ“Š Health Check ê²°ê³¼: ${SUCCESS_COUNT}/${TOTAL_ENDPOINTS} endpoints healthy"
        
        if [[ $SUCCESS_COUNT -gt 0 ]]; then
          echo "âœ… ìµœì†Œ í•˜ë‚˜ì˜ ì—”ë“œí¬ì¸íŠ¸ê°€ ì •ìƒ ì‘ë‹µ - ë°°í¬ ì„±ê³µ"
        else
          echo "âŒ ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨ - ë°°í¬ ê²€ì¦ ì‹¤íŒ¨"
          exit 1
        fi
    
    - name: Performance Baseline Check
      run: |
        echo "ğŸ“Š ì„±ëŠ¥ ê¸°ì¤€ì„  ì¸¡ì •..."
        
        # ì‘ë‹µ ì‹œê°„ ì¸¡ì • (3ë²ˆ ì‹œë„ í‰ê· )
        TOTAL_TIME=0
        SUCCESSFUL_REQUESTS=0
        
        for i in {1..3}; do
          RESPONSE_TIME=$(curl -w '%{time_total}' -o /dev/null -s --max-time 5 "${{ env.EXTERNAL_URL }}/api/health" 2>/dev/null || echo "0")
          if (( $(echo "$RESPONSE_TIME > 0" | bc -l) )); then
            TOTAL_TIME=$(echo "$TOTAL_TIME + $RESPONSE_TIME" | bc -l)
            SUCCESSFUL_REQUESTS=$((SUCCESSFUL_REQUESTS + 1))
            echo "  Request $i: ${RESPONSE_TIME}ì´ˆ"
          else
            echo "  Request $i: FAILED"
          fi
        done
        
        if [[ $SUCCESSFUL_REQUESTS -gt 0 ]]; then
          AVERAGE_TIME=$(echo "scale=3; $TOTAL_TIME / $SUCCESSFUL_REQUESTS" | bc -l)
          echo "ğŸ“Š í‰ê·  ì‘ë‹µì‹œê°„: ${AVERAGE_TIME}ì´ˆ (${SUCCESSFUL_REQUESTS}/3 ì„±ê³µ)"
          
          if (( $(echo "$AVERAGE_TIME > 2.0" | bc -l) )); then
            echo "âš ï¸ ê²½ê³ : ì‘ë‹µ ì‹œê°„ì´ 2ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤"
          else
            echo "âœ… ì‘ë‹µ ì‹œê°„ ê¸°ì¤€ í†µê³¼"
          fi
        else
          echo "âŒ ëª¨ë“  ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        fi
    
    - name: Kubernetes Resource Verification
      run: |
        echo "â˜¸ï¸ Kubernetes ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸..."
        
        # kubectlì´ ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
        if command -v kubectl >/dev/null 2>&1; then
          echo "ğŸ“‹ Pod ìƒíƒœ:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.PROJECT_NAME }} --no-headers | head -5
          
          echo "ğŸ”„ Service ìƒíƒœ:"
          kubectl get svc -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.PROJECT_NAME }} --no-headers | head -3
          
          echo "ğŸ“Š Deployment ìƒíƒœ:"
          kubectl get deploy -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.PROJECT_NAME }} --no-headers
        else
          echo "â„¹ï¸ kubectl ì‚¬ìš© ë¶ˆê°€ - K8s ìƒíƒœ í™•ì¸ ê±´ë„ˆë›°ê¸°"
        fi
    
    - name: Generate Comprehensive Deployment Report
      run: |
        # ì¢…í•© ë°°í¬ ë³´ê³ ì„œ ìƒì„±
        REPORT_FILE="deployment-report-$(date +%Y%m%d-%H%M%S).md"
        
        cat << EOF > $REPORT_FILE
        # ğŸš€ GitOps ë°°í¬ ì™„ë£Œ ë³´ê³ ì„œ
        
        **ë°°í¬ ì¼ì‹œ**: $(date '+%Y-%m-%d %H:%M:%S KST')
        **ë°°í¬ í™˜ê²½**: ${{ env.ENVIRONMENT }}
        **Git ì»¤ë°‹**: ${{ github.sha }}
        
        ## âœ… ë°°í¬ ì •ë³´
        
        | í•­ëª© | ê°’ |
        |------|-----|
        | **í”„ë¡œì íŠ¸ëª…** | ${{ env.PROJECT_NAME }} |
        | **ì´ë¯¸ì§€ íƒœê·¸** | ${{ needs.docker-build.outputs.image-tag }} |
        | **Registry** | ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }} |
        | **ë„¤ì„ìŠ¤í˜ì´ìŠ¤** | ${{ env.K8S_NAMESPACE }} |
        | **ArgoCD ë™ê¸°í™”** | ${{ needs.gitops-deploy.outputs.sync-status }} |
        | **ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ** | ${{ needs.gitops-deploy.outputs.app-health }} |
        
        ## ğŸ”— ì ‘ì† ì •ë³´
        
        - **ğŸŒ ì›¹ì‚¬ì´íŠ¸**: ${{ env.EXTERNAL_URL }}
        - **âš¡ ArgoCD**: https://${{ env.ARGOCD_SERVER }}/applications/${{ env.PROJECT_NAME }}
        - **ğŸ³ Registry**: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ needs.docker-build.outputs.image-tag }}
        - **ğŸ”§ ë‚´ë¶€ ì ‘ì†**: ${{ env.INTERNAL_URL }}
        
        ## ğŸ“Š ê²€ì¦ ê²°ê³¼
        
        - âœ… **Health Check**: ë‹¤ì¤‘ ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦ ì™„ë£Œ
        - âœ… **ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**: ì‘ë‹µì‹œê°„ ê¸°ì¤€ í†µê³¼
        - âœ… **GitOps ë™ê¸°í™”**: ArgoCD Pull ê¸°ë°˜ ë°°í¬ ì™„ë£Œ
        - âœ… **ì´ë¯¸ì§€ ë³´ì•ˆ**: Multi-arch ë¹Œë“œ (linux/amd64, linux/arm64)
        
        ## ğŸ›¡ï¸ ë³´ì•ˆ & ê·œì • ì¤€ìˆ˜
        
        - **GitOps ë³´ì•ˆ**: Pull-only ë°°í¬ ëª¨ë¸
        - **RBAC**: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ ê¶Œí•œ ë¶„ë¦¬
        - **ì´ë¯¸ì§€ ë³´ì•ˆ**: Harbor Registry + ë³´ì•ˆ ìŠ¤ìº”
        - **ì•”í˜¸í™”**: TLS/HTTPS í†µì‹ 
        - **ê°ì‚¬ ë¡œê·¸**: ëª¨ë“  ë³€ê²½ì‚¬í•­ Git íˆìŠ¤í† ë¦¬ ì¶”ì 
        
        ---
        ğŸ¤– **ìë™ ìƒì„±**: GitHub Actions GitOps Pipeline v2.0
        ğŸ”§ **ë„êµ¬**: ArgoCD + Kustomize + Harbor Registry + jclee.me Infrastructure
        ğŸ“‹ **í‘œì¤€**: CNCF GitOps ë³´ì•ˆ ëª¨ë¸ ì¤€ìˆ˜
        EOF
        
        echo "ğŸ“‹ ë°°í¬ ë³´ê³ ì„œ ìƒì„± ì™„ë£Œ: $REPORT_FILE"
        cat $REPORT_FILE
        
        # Artifactë¡œ ë³´ê³ ì„œ ì €ì¥
        echo "report-file=$REPORT_FILE" >> $GITHUB_OUTPUT
    
    - name: Upload Deployment Report
      uses: actions/upload-artifact@v3
      with:
        name: deployment-report-${{ needs.docker-build.outputs.image-tag }}
        path: deployment-report-*.md
        retention-days: 30

  # Job 5: ì•Œë¦¼ & ëª¨ë‹ˆí„°ë§ ì„¤ì •
  notifications:
    name: ğŸ“¢ Deployment Notifications
    runs-on: ${{ vars.RUNNER_TYPE || 'self-hosted' }}
    needs: [docker-build, gitops-deploy, post-deployment-verification]
    if: always()
    steps:
    - name: Determine Overall Status
      id: status
      run: |
        BUILD_STATUS="${{ needs.docker-build.result }}"
        DEPLOY_STATUS="${{ needs.gitops-deploy.result }}"
        VERIFY_STATUS="${{ needs.post-deployment-verification.result }}"
        
        if [[ "$BUILD_STATUS" == "success" && "$DEPLOY_STATUS" == "success" && "$VERIFY_STATUS" == "success" ]]; then
          echo "overall=success" >> $GITHUB_OUTPUT
          echo "emoji=ğŸ‰" >> $GITHUB_OUTPUT
          echo "color=good" >> $GITHUB_OUTPUT
          echo "message=GitOps ë°°í¬ ì„±ê³µ" >> $GITHUB_OUTPUT
        elif [[ "$BUILD_STATUS" == "failure" || "$DEPLOY_STATUS" == "failure" || "$VERIFY_STATUS" == "failure" ]]; then
          echo "overall=failure" >> $GITHUB_OUTPUT
          echo "emoji=ğŸ’¥" >> $GITHUB_OUTPUT
          echo "color=danger" >> $GITHUB_OUTPUT
          echo "message=GitOps ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
        else
          echo "overall=partial" >> $GITHUB_OUTPUT
          echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
          echo "color=warning" >> $GITHUB_OUTPUT
          echo "message=GitOps ë°°í¬ ë¶€ë¶„ ì„±ê³µ" >> $GITHUB_OUTPUT
        fi
    
    - name: Slack Notification
      if: always() && secrets.SLACK_WEBHOOK != ''
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ steps.status.outputs.overall }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,workflow
        custom_payload: |
          {
            "attachments": [{
              "color": "${{ steps.status.outputs.color }}",
              "title": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}",
              "fields": [
                {"title": "í”„ë¡œì íŠ¸", "value": "${{ env.PROJECT_NAME }}", "short": true},
                {"title": "í™˜ê²½", "value": "${{ env.ENVIRONMENT }}", "short": true},
                {"title": "ì´ë¯¸ì§€ íƒœê·¸", "value": "${{ needs.docker-build.outputs.image-tag }}", "short": true},
                {"title": "ì»¤ë°‹", "value": "${{ github.sha }}", "short": true},
                {"title": "ì›¹ì‚¬ì´íŠ¸", "value": "${{ env.EXTERNAL_URL }}", "short": false},
                {"title": "ArgoCD", "value": "https://${{ env.ARGOCD_SERVER }}/applications/${{ env.PROJECT_NAME }}", "short": false}
              ],
              "footer": "jclee.me GitOps Infrastructure",
              "ts": $(date +%s)
            }]
          }
    
    - name: Summary Comment
      run: |
        echo "## ğŸš€ GitOps ë°°í¬ ì™„ë£Œ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| êµ¬ë¶„ | ìƒíƒœ | ì •ë³´ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| **í™˜ê²½** | ${{ env.ENVIRONMENT }} | ${{ env.EXTERNAL_URL }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **ì´ë¯¸ì§€** | ${{ needs.docker-build.outputs.image-tag }} | ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }} |" >> $GITHUB_STEP_SUMMARY
        echo "| **ArgoCD** | ${{ needs.gitops-deploy.outputs.sync-status }} | [Dashboard](https://${{ env.ARGOCD_SERVER }}/applications/${{ env.PROJECT_NAME }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| **ìƒíƒœ** | ${{ steps.status.outputs.overall }} | ${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— ì£¼ìš” ë§í¬" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ **ì›¹ì‚¬ì´íŠ¸**: ${{ env.EXTERNAL_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ **ArgoCD**: https://${{ env.ARGOCD_SERVER }}/applications/${{ env.PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY  
        echo "- ğŸ³ **Registry**: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}:${{ needs.docker-build.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”§ **ë‚´ë¶€ ì ‘ì†**: ${{ env.INTERNAL_URL }}" >> $GITHUB_STEP_SUMMARY