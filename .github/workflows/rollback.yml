name: ğŸ”„ GitOps Rollback Automation

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: 'ë¡¤ë°± ëŒ€ìƒ (commit SHA ë˜ëŠ” tag)'
        required: true
        type: string
      rollback_reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string
      emergency:
        description: 'ê¸´ê¸‰ ë¡¤ë°± ì—¬ë¶€'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: fortinet
  K8S_NAMESPACE: fortinet-prod
  DEPLOYMENT_HOST: 192.168.50.110
  DEPLOYMENT_PORT: 30777

jobs:
  # ë¡¤ë°± ì „ ê²€ì¦
  pre-rollback-check:
    runs-on: self-hosted
    outputs:
      rollback-safe: ${{ steps.safety-check.outputs.safe }}
      current-image: ${{ steps.current-state.outputs.image }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” í˜„ì¬ ìƒíƒœ í™•ì¸
        id: current-state
        run: |
          echo "ğŸ” í˜„ì¬ ë°°í¬ ìƒíƒœ í™•ì¸..."
          
          # í˜„ì¬ kustomization.yamlì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ì¶”ì¶œ
          current_tag=$(grep "newTag:" k8s/overlays/production/kustomization.yaml | awk '{print $2}')
          echo "í˜„ì¬ ì´ë¯¸ì§€ íƒœê·¸: $current_tag"
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$current_tag" >> $GITHUB_OUTPUT
          
          # í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          if curl -f -s --connect-timeout 10 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > /dev/null; then
            echo "âœ… í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ: ì •ìƒ"
            echo "current-status=healthy" >> $GITHUB_OUTPUT
          else
            echo "âŒ í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ: ë¹„ì •ìƒ"
            echo "current-status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” ë¡¤ë°± ëŒ€ìƒ ê²€ì¦
        run: |
          echo "ğŸ” ë¡¤ë°± ëŒ€ìƒ ê²€ì¦ ì¤‘..."
          rollback_target="${{ inputs.rollback_target }}"
          
          # Git ì»¤ë°‹/íƒœê·¸ ì¡´ì¬ í™•ì¸
          if git rev-parse --verify "$rollback_target" >/dev/null 2>&1; then
            echo "âœ… ë¡¤ë°± ëŒ€ìƒ ìœ íš¨: $rollback_target"
            rollback_sha=$(git rev-parse "$rollback_target")
            echo "ë¡¤ë°± SHA: $rollback_sha"
          else
            echo "âŒ ë¡¤ë°± ëŒ€ìƒ ë¬´íš¨: $rollback_target"
            exit 1
          fi
          
          # Docker ì´ë¯¸ì§€ ì¡´ì¬ í™•ì¸
          rollback_image="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$rollback_target"
          if docker manifest inspect "$rollback_image" >/dev/null 2>&1; then
            echo "âœ… ë¡¤ë°± ì´ë¯¸ì§€ ì¡´ì¬: $rollback_image"
          else
            echo "âŒ ë¡¤ë°± ì´ë¯¸ì§€ ì—†ìŒ: $rollback_image"
            echo "ğŸ”„ ì´ë¯¸ì§€ ë¹Œë“œê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          fi

      - name: ğŸ›¡ï¸ ì•ˆì „ì„± ê²€ì‚¬
        id: safety-check
        run: |
          echo "ğŸ›¡ï¸ ë¡¤ë°± ì•ˆì „ì„± ê²€ì‚¬..."
          
          # ê¸´ê¸‰ ë¡¤ë°±ì¸ ê²½ìš° ì•ˆì „ì„± ê²€ì‚¬ ìƒëµ
          if [ "${{ inputs.emergency }}" = "true" ]; then
            echo "ğŸš¨ ê¸´ê¸‰ ë¡¤ë°± ëª¨ë“œ - ì•ˆì „ì„± ê²€ì‚¬ ìƒëµ"
            echo "safe=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # ì¼ë°˜ ë¡¤ë°± ì•ˆì „ì„± ê²€ì‚¬
          rollback_safe=true
          
          # 1. í˜„ì¬ ì„œë¹„ìŠ¤ê°€ ì •ìƒì¸ì§€ í™•ì¸
          if [ "${{ steps.current-state.outputs.current-status }}" = "healthy" ]; then
            echo "âš ï¸ í˜„ì¬ ì„œë¹„ìŠ¤ê°€ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤. ë¡¤ë°±ì´ í•„ìš”í•œì§€ ì¬ê²€í† í•´ì£¼ì„¸ìš”."
            read -p "ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm
            if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
              rollback_safe=false
            fi
          fi
          
          # 2. ìµœê·¼ ì»¤ë°‹ì¸ì§€ í™•ì¸ (ì•ˆì „ì„±ì„ ìœ„í•´)
          rollback_commit_date=$(git log -1 --format="%at" "${{ inputs.rollback_target }}")
          week_ago=$(($(date +%s) - 604800))  # 7ì¼ ì „
          
          if [ "$rollback_commit_date" -lt "$week_ago" ]; then
            echo "âš ï¸ 1ì£¼ì¼ ì´ì „ ì»¤ë°‹ìœ¼ë¡œì˜ ë¡¤ë°±ì…ë‹ˆë‹¤. ë°ì´í„° í˜¸í™˜ì„±ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi
          
          echo "safe=$rollback_safe" >> $GITHUB_OUTPUT

  # GitOps ë¡¤ë°± ì‹¤í–‰
  execute-rollback:
    runs-on: self-hosted
    needs: pre-rollback-check
    if: needs.pre-rollback-check.outputs.rollback-safe == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”„ Kustomize ë¡¤ë°± ì‹¤í–‰
        run: |
          echo "ğŸ”„ GitOps ë¡¤ë°± ì‹¤í–‰ ì¤‘..."
          
          rollback_target="${{ inputs.rollback_target }}"
          echo "ë¡¤ë°± ëŒ€ìƒ: $rollback_target"
          
          cd k8s/overlays/production
          
          # ë°±ì—… ìƒì„±
          cp kustomization.yaml kustomization.yaml.backup.$(date +%Y%m%d-%H%M%S)
          
          # ìƒˆë¡œìš´ ì´ë¯¸ì§€ íƒœê·¸ë¡œ ì—…ë°ì´íŠ¸
          sed -i "s/newTag:.*/newTag: $rollback_target  # GitOps ë¡¤ë°±/" kustomization.yaml
          
          echo "ğŸ“ ì—…ë°ì´íŠ¸ëœ kustomization.yaml:"
          cat kustomization.yaml

      - name: ğŸ“¤ ë¡¤ë°± ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions (Rollback)"
          
          git add k8s/overlays/production/kustomization.yaml
          
          git commit -m "ğŸ”„ GitOps Rollback: ${{{ inputs.rollback_target }}}

          ğŸ”„ GitOps ìë™ ë¡¤ë°±
          - Target: ${{ inputs.rollback_target }}
          - Reason: ${{ inputs.rollback_reason }}
          - Emergency: ${{ inputs.emergency }}
          - Initiated by: ${{ github.actor }}
          - Timestamp: $(date -u)
          
          Previous image: ${{ needs.pre-rollback-check.outputs.current-image }}
          Rollback image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.rollback_target }}
          
          Co-authored-by: GitHub Actions (Rollback) <action@github.com>"
          
          git push
          echo "âœ… ë¡¤ë°± ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ!"

      - name: â±ï¸ ArgoCD ë™ê¸°í™” ëŒ€ê¸°
        run: |
          echo "ğŸ”„ ArgoCDê°€ ë¡¤ë°± ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ê³  ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          echo "â±ï¸ ë¡¤ë°± ì™„ë£Œê¹Œì§€ ì•½ 2-3ë¶„ ì†Œìš”ë©ë‹ˆë‹¤."
          sleep 120  # ArgoCD ë™ê¸°í™” ì‹œê°„ í™•ë³´

  # ë¡¤ë°± ê²€ì¦
  verify-rollback:
    runs-on: self-hosted
    needs: execute-rollback
    steps:
      - name: ğŸ¥ ë¡¤ë°± ê²°ê³¼ ê²€ì¦
        run: |
          max_attempts=12
          attempt=1
          
          echo "ğŸ” ë¡¤ë°± ê²°ê³¼ ê²€ì¦ ì‹œì‘..."
          echo "ğŸ¯ Target: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health"
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ ì‹œë„ $attempt/$max_attempts: ë¡¤ë°± ìƒíƒœ í™•ì¸..."
            
            if curl -f -s --connect-timeout 10 --max-time 20 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > health.json; then
              echo "âœ… ë¡¤ë°± í›„ ì„œë¹„ìŠ¤ ì •ìƒ!"
              echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ì‘ë‹µ:"
              cat health.json | jq . 2>/dev/null || cat health.json
              
              # ì´ë¯¸ì§€ ì •ë³´ í™•ì¸
              if grep -q "${{ inputs.rollback_target }}" health.json; then
                echo "âœ… ë¡¤ë°± ì´ë¯¸ì§€ í™•ì¸ë¨: ${{ inputs.rollback_target }}"
              fi
              
              echo "ğŸ‰ ë¡¤ë°± ì™„ë£Œ!"
              break
            else
              echo "âš ï¸ ë¡¤ë°± ê²€ì¦ ì‹¤íŒ¨ (ì‹œë„ $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ ë¡¤ë°± ê²€ì¦ ì‹¤íŒ¨! ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš”!"
                echo "ğŸ†˜ ë‹¤ìŒ ì¡°ì¹˜ë¥¼ ì¦‰ì‹œ ìˆ˜í–‰í•˜ì„¸ìš”:"
                echo "   1. ArgoCD ëŒ€ì‹œë³´ë“œ í™•ì¸: https://argo.jclee.me"
                echo "   2. Pod ìƒíƒœ í™•ì¸: kubectl get pods -n ${{ env.K8S_NAMESPACE }}"
                echo "   3. Pod ë¡œê·¸ í™•ì¸: kubectl logs -l app=fortinet -n ${{ env.K8S_NAMESPACE }}"
                echo "   4. í•„ìš”ì‹œ ìˆ˜ë™ ë¡¤ë°± ì‹¤í–‰"
                exit 1
              fi
              echo "â³ 20ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 20
              attempt=$((attempt + 1))
            fi
          done

      - name: ğŸ“Š ë¡¤ë°± ì™„ë£Œ ë³´ê³ ì„œ
        if: success()
        run: |
          echo "ğŸ“‹ ë¡¤ë°± ì™„ë£Œ ë³´ê³ ì„œ"
          echo "==================="
          echo "ë¡¤ë°± ëŒ€ìƒ: ${{ inputs.rollback_target }}"
          echo "ë¡¤ë°± ì‚¬ìœ : ${{ inputs.rollback_reason }}"
          echo "ì‹¤í–‰ì: ${{ github.actor }}"
          echo "ì™„ë£Œ ì‹œê°„: $(date -u)"
          echo "ì„œë¹„ìŠ¤ URL: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}"
          echo "ArgoCD: https://argo.jclee.me"
          echo ""
          echo "âœ… ë¡¤ë°±ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"

  # ë¡¤ë°± ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  rollback-failure-notification:
    runs-on: self-hosted
    needs: [pre-rollback-check, execute-rollback, verify-rollback]
    if: failure()
    steps:
      - name: ğŸš¨ ë¡¤ë°± ì‹¤íŒ¨ ê¸´ê¸‰ ì•Œë¦¼
        run: |
          echo "ğŸš¨ ë¡¤ë°± ì‹¤íŒ¨ - ê¸´ê¸‰ ì•Œë¦¼ ë°œì†¡!"
          echo ""
          echo "âŒ FortiGate Nextrade ë¡¤ë°± ì‹¤íŒ¨"
          echo "ëŒ€ìƒ: ${{ inputs.rollback_target }}"
          echo "ì‚¬ìœ : ${{ inputs.rollback_reason }}"
          echo "ì‹¤í–‰ì: ${{ github.actor }}"
          echo "ì‹¤íŒ¨ ì‹œê°„: $(date -u)"
          echo ""
          echo "ğŸ†˜ ì¦‰ì‹œ ìˆ˜ë™ ê°œì…ì´ í•„ìš”í•©ë‹ˆë‹¤!"
          
          # Slack ì•Œë¦¼ (ì‹¤ì œ êµ¬í˜„ì—ì„œ í™œì„±í™”)
          # if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          #   curl -X POST -H 'Content-type: application/json' \
          #     --data '{"text": "ğŸš¨ URGENT: FortiGate Nextrade ë¡¤ë°± ì‹¤íŒ¨!"}' \
          #     ${{ secrets.SLACK_WEBHOOK_URL }}
          # fi