name: ğŸ” GitOps Deployment Status Monitor

on:
  schedule:
    - cron: '*/5 * * * *'  # 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

env:
  DEPLOYMENT_HOST: 192.168.50.110
  DEPLOYMENT_PORT: 30777
  ARGOCD_SERVER: argo.jclee.me

jobs:
  monitor:
    runs-on: self-hosted
    steps:
      - name: ğŸ” Health Check
        id: health
        run: |
          echo "ğŸ¥ ì„œë¹„ìŠ¤ Health Check ì‹¤í–‰..."
          
          if curl -f -s --connect-timeout 5 --max-time 10 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > /dev/null; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ"
            
            # Health ì •ë³´ ì¡°íšŒ
            HEALTH_INFO=$(curl -s "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health")
            echo "health_info=$HEALTH_INFO" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ ì„œë¹„ìŠ¤ ë¹„ì •ìƒ"
          fi

      - name: ğŸ“Š Status Report
        run: |
          echo "ğŸ“Š GitOps ë°°í¬ ìƒíƒœ ë³´ê³ ì„œ"
          echo "========================="
          echo ""
          echo "ğŸ¥ Health Status: ${{ steps.health.outputs.status }}"
          echo "ğŸ”— Service URL: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}"
          echo "ğŸŒ External URL: https://fortinet.jclee.me"
          echo "ğŸ“Š ArgoCD: https://${{ env.ARGOCD_SERVER }}"
          echo ""
          
          if [ "${{ steps.health.outputs.status }}" = "healthy" ]; then
            echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."
            if [ -n "${{ steps.health.outputs.health_info }}" ]; then
              echo ""
              echo "ğŸ“‹ Health Details:"
              echo "${{ steps.health.outputs.health_info }}"
            fi
          else
            echo "âŒ ì„œë¹„ìŠ¤ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
            echo ""
            echo "ğŸ” ë¬¸ì œ í•´ê²° ë‹¨ê³„:"
            echo "1. ArgoCD ìƒíƒœ í™•ì¸: https://${{ env.ARGOCD_SERVER }}"
            echo "2. Pod ë¡œê·¸ í™•ì¸: kubectl logs -l app=fortinet -n fortinet"
            echo "3. Service ìƒíƒœ í™•ì¸: kubectl get svc -n fortinet"
          fi