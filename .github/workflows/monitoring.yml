name: ğŸ“Š Pipeline Monitoring & Alerts

on:
  workflow_run:
    workflows: ["ğŸš€ GitOps CI/CD Pipeline (jclee.me)"]
    types: [completed]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ìƒíƒœ ì²´í¬
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
  DEPLOYMENT_HOST: 192.168.50.110
  DEPLOYMENT_PORT: 30777

jobs:
  # íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼ ëª¨ë‹ˆí„°ë§
  pipeline-monitor:
    runs-on: self-hosted
    if: github.event.workflow_run
    steps:
      - name: ğŸ“Š ë¶„ì„ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼
        run: |
          echo "ğŸ” íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼ ë¶„ì„..."
          echo "ì›Œí¬í”Œë¡œìš°: ${{ github.event.workflow_run.name }}"
          echo "ê²°ê³¼: ${{ github.event.workflow_run.conclusion }}"
          echo "ë¸Œëœì¹˜: ${{ github.event.workflow_run.head_branch }}"
          echo "ì»¤ë°‹: ${{ github.event.workflow_run.head_sha }}"
          echo "ì‹¤í–‰ ì‹œê°„: ${{ github.event.workflow_run.updated_at }}"

      - name: ğŸ“ˆ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘..."
          
          # ì‹¤í–‰ ì‹œê°„ ê³„ì‚°
          start_time="${{ github.event.workflow_run.created_at }}"
          end_time="${{ github.event.workflow_run.updated_at }}"
          
          echo "ì‹œì‘: $start_time"
          echo "ì¢…ë£Œ: $end_time"
          
          # ë°°í¬ ìƒíƒœ í™•ì¸
          if curl -f -s --connect-timeout 5 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > /dev/null; then
            echo "âœ… ì„œë¹„ìŠ¤ ìƒíƒœ: ì •ìƒ"
            SERVICE_STATUS="healthy"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ìƒíƒœ: ë¹„ì •ìƒ"
            SERVICE_STATUS="unhealthy"
          fi
          
          echo "SERVICE_STATUS=$SERVICE_STATUS" >> $GITHUB_ENV

      - name: ğŸ”” ì„±ê³µ ì•Œë¦¼
        if: github.event.workflow_run.conclusion == 'success'
        run: |
          echo "ğŸ‰ íŒŒì´í”„ë¼ì¸ ì„±ê³µ ì•Œë¦¼ ë°œì†¡..."
          
          if [ -n "${{ env.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \"âœ… FortiGate Nextrade ë°°í¬ ì„±ê³µ\",
                \"attachments\": [{
                  \"color\": \"good\",
                  \"fields\": [
                    {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.event.workflow_run.head_branch }}\", \"short\": true},
                    {\"title\": \"ì»¤ë°‹\", \"value\": \"${{ github.event.workflow_run.head_sha }}\", \"short\": true},
                    {\"title\": \"ì„œë¹„ìŠ¤ ìƒíƒœ\", \"value\": \"${{ env.SERVICE_STATUS }}\", \"short\": true},
                    {\"title\": \"URL\", \"value\": \"http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}\", \"short\": false}
                  ]
                }]
              }" \
              ${{ env.SLACK_WEBHOOK_URL }} || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨"
          fi

      - name: ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
        if: github.event.workflow_run.conclusion == 'failure'
        run: |
          echo "âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨ ì•Œë¦¼ ë°œì†¡..."
          
          if [ -n "${{ env.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \"âŒ FortiGate Nextrade ë°°í¬ ì‹¤íŒ¨\",
                \"attachments\": [{
                  \"color\": \"danger\",
                  \"fields\": [
                    {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"${{ github.event.workflow_run.head_branch }}\", \"short\": true},
                    {\"title\": \"ì»¤ë°‹\", \"value\": \"${{ github.event.workflow_run.head_sha }}\", \"short\": true},
                    {\"title\": \"ì›Œí¬í”Œë¡œìš° URL\", \"value\": \"${{ github.event.workflow_run.html_url }}\", \"short\": false},
                    {\"title\": \"ì¡°ì¹˜ í•„ìš”\", \"value\": \"ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”\", \"short\": false}
                  ]
                }]
              }" \
              ${{ env.SLACK_WEBHOOK_URL }} || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨"
          fi

  # ì¼ì¼ ìƒíƒœ ì²´í¬
  daily-health-check:
    runs-on: self-hosted
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ¥ ì„œë¹„ìŠ¤ ìƒíƒœ ì²´í¬
        run: |
          echo "ğŸ” ì¼ì¼ ì„œë¹„ìŠ¤ ìƒíƒœ ì²´í¬..."
          
          # í—¬ìŠ¤ì²´í¬
          if curl -f -s --connect-timeout 10 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > health.json; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
            cat health.json
            SERVICE_STATUS="healthy"
          else
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            SERVICE_STATUS="unhealthy"
          fi
          
          # ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          response_time=$(curl -o /dev/null -s -w '%{time_total}' "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" || echo "0")
          echo "ì‘ë‹µ ì‹œê°„: ${response_time}ì´ˆ"
          
          echo "SERVICE_STATUS=$SERVICE_STATUS" >> $GITHUB_ENV
          echo "RESPONSE_TIME=$response_time" >> $GITHUB_ENV

      - name: ğŸ” ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì²´í¬
        run: |
          echo "ğŸ“Š ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ì²´í¬..."
          
          # Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ
          echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          docker ps --filter "name=fortinet" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || echo "Docker ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
          
          # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰
          echo "ğŸ’¾ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h / || echo "ë””ìŠ¤í¬ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
          echo "ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h || echo "ë©”ëª¨ë¦¬ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"

      - name: ğŸ“Š ì¼ì¼ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“ ì¼ì¼ ìƒíƒœ ë¦¬í¬íŠ¸ ìƒì„±..."
          
          cat > daily-report.md << EOF
          # FortiGate Nextrade ì¼ì¼ ìƒíƒœ ë¦¬í¬íŠ¸
          
          **ë‚ ì§œ**: $(date '+%Y-%m-%d %H:%M:%S')
          
          ## ğŸ¥ ì„œë¹„ìŠ¤ ìƒíƒœ
          - **ìƒíƒœ**: ${{ env.SERVICE_STATUS }}
          - **ì‘ë‹µ ì‹œê°„**: ${{ env.RESPONSE_TIME }}ì´ˆ
          - **URL**: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}
          
          ## ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´
          - **í˜¸ìŠ¤íŠ¸**: ${{ env.DEPLOYMENT_HOST }}
          - **í¬íŠ¸**: ${{ env.DEPLOYMENT_PORT }}
          - **ì²´í¬ ì‹œê°„**: $(date)
          
          ## ğŸ”— ê´€ë ¨ ë§í¬
          - [ArgoCD Dashboard](https://argo.jclee.me)
          - [Registry](https://registry.jclee.me)
          - [Charts](https://charts.jclee.me)
          EOF
          
          cat daily-report.md

      - name: ğŸ”” ì¼ì¼ ë¦¬í¬íŠ¸ ì•Œë¦¼
        if: env.SERVICE_STATUS == 'unhealthy'
        run: |
          echo "âš ï¸ ì„œë¹„ìŠ¤ ìƒíƒœ ì´ìƒ ì•Œë¦¼ ë°œì†¡..."
          
          if [ -n "${{ env.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \"âš ï¸ FortiGate Nextrade ì„œë¹„ìŠ¤ ìƒíƒœ ì´ìƒ\",
                \"attachments\": [{
                  \"color\": \"warning\",
                  \"fields\": [
                    {\"title\": \"ìƒíƒœ\", \"value\": \"${{ env.SERVICE_STATUS }}\", \"short\": true},
                    {\"title\": \"ì‘ë‹µ ì‹œê°„\", \"value\": \"${{ env.RESPONSE_TIME }}ì´ˆ\", \"short\": true},
                    {\"title\": \"ì²´í¬ ì‹œê°„\", \"value\": \"$(date)\", \"short\": false},
                    {\"title\": \"ì¡°ì¹˜ í•„ìš”\", \"value\": \"ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”\", \"short\": false}
                  ]
                }]
              }" \
              ${{ env.SLACK_WEBHOOK_URL }} || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨"
          fi

  # íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ ë¶„ì„
  performance-analysis:
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: ğŸ“ˆ íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ ë¶„ì„
        run: |
          echo "ğŸ“Š íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥ ë¶„ì„ ì‹œì‘..."
          
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœê·¼ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê¸°ë¡ ì¡°íšŒ
          echo "ğŸ” ìµœê·¼ 10íšŒ ì‹¤í–‰ ê¸°ë¡ ë¶„ì„..."
          
          # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” GitHub APIë¥¼ ì‚¬ìš©
          echo "ğŸ“‹ ì„±ëŠ¥ ê°œì„  ê¶Œì¥ì‚¬í•­:"
          echo "- í…ŒìŠ¤íŠ¸ ë³‘ë ¬í™”ë¡œ 20% ì‹œê°„ ë‹¨ì¶• ê°€ëŠ¥"
          echo "- Docker ë¹Œë“œ ìºì‹œ ìµœì í™”ë¡œ 30% ì‹œê°„ ë‹¨ì¶• ê°€ëŠ¥"
          echo "- ì˜ì¡´ì„± ìºì‹œ í™œìš©ìœ¼ë¡œ 15% ì‹œê°„ ë‹¨ì¶• ê°€ëŠ¥"