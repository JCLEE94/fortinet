name: ğŸš€ Manual GitOps Trigger

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_rebuild:
        description: 'Docker ì´ë¯¸ì§€ ê°•ì œ ë¦¬ë¹Œë“œ'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: fortinet
  APP_NAME: fortinet
  K8S_NAMESPACE: fortinet
  ARGOCD_SERVER: argo.jclee.me
  DEPLOYMENT_HOST: 192.168.50.110
  DEPLOYMENT_PORT: 30777

jobs:
  manual-gitops-deploy:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to jclee.me Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: ğŸ“‹ Generate Image Tags
        id: tags
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}"
          
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Generated Image Tag: ${IMAGE_TAG}"

      - name: ğŸš€ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.production
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=FortiGate Nextrade
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            gitops.manual-trigger=true
            gitops.environment=${{ github.event.inputs.environment }}

      - name: ğŸ”„ Update GitOps Manifests
        run: |
          cd k8s/overlays/${{ github.event.inputs.environment }}
          
          # Kustomizeì—ì„œ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s/newTag:.*/newTag: ${{ steps.tags.outputs.IMAGE_TAG }}/" kustomization.yaml
          
          echo "ğŸ“ Updated kustomization.yaml for ${{ github.event.inputs.environment }}:"
          cat kustomization.yaml

      - name: ğŸ“¤ Commit GitOps Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions (Manual GitOps)"
          
          git add k8s/overlays/${{ github.event.inputs.environment }}/kustomization.yaml
          git add DEPLOYMENT_TRIGGER.md
          
          if git diff --staged --quiet; then
            echo "âš ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸš€ Manual GitOps: Deploy ${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.IMAGE_TAG }}

ğŸ¯ ìˆ˜ë™ GitOps ë°°í¬ ì‹¤í–‰
- Environment: ${{ github.event.inputs.environment }}
- Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.IMAGE_TAG }}
- Commit: ${{ github.sha }}
- Trigger: Manual workflow dispatch
- Timestamp: ${{ steps.tags.outputs.TIMESTAMP }}

ğŸ”„ GitOps í”„ë¡œì„¸ìŠ¤:
1. Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ
2. Kustomize ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
3. ArgoCD ìë™ ë™ê¸°í™” ëŒ€ê¸° ì¤‘
4. K8s í´ëŸ¬ìŠ¤í„° ë°°í¬ ì§„í–‰

Co-authored-by: GitHub Actions <action@github.com>"
            
            git push
            echo "âœ… GitOps ë³€ê²½ì‚¬í•­ Push ì™„ë£Œ!"
          fi

      - name: â±ï¸ ArgoCD ë™ê¸°í™” ëŒ€ê¸°
        run: |
          echo "ğŸ”„ ArgoCD Pull-based GitOps ë™ê¸°í™” ì‹œì‘..."
          echo "ğŸ“Š ArgoCD Dashboard: https://${{ env.ARGOCD_SERVER }}/applications/${{ env.APP_NAME }}"
          echo "âŒ› ìë™ ë™ê¸°í™” ì™„ë£Œê¹Œì§€ ì•½ 2-3ë¶„ ì†Œìš”"
          sleep 120

      - name: ğŸ” ë°°í¬ ìƒíƒœ ê²€ì¦
        run: |
          echo "ğŸ” ë°°í¬ ìƒíƒœ ê²€ì¦ ì‹œì‘..."
          max_attempts=20
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ ê²€ì¦ ì‹œë„ $attempt/$max_attempts"
            
            if curl -f -s --connect-timeout 10 --max-time 20 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > /dev/null; then
              echo "âœ… ë°°í¬ ê²€ì¦ ì„±ê³µ!"
              echo "ğŸ“Š Health Check ì‘ë‹µ:"
              curl -s "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" | jq . 2>/dev/null || curl -s "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health"
              break
            else
              echo "âš ï¸ Health Check ì‹¤íŒ¨ (ì‹œë„ $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨!"
                exit 1
              fi
              echo "â³ 15ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 15
              attempt=$((attempt + 1))
            fi
          done

      - name: ğŸ“Š ë°°í¬ ì™„ë£Œ ë³´ê³ ì„œ
        if: success()
        run: |
          echo ""
          echo "ğŸš€ GITOPS ë°°í¬ ì™„ë£Œ ë³´ê³ ì„œ"
          echo "========================="
          echo ""
          echo "âœ… ë°°í¬ ì •ë³´:"
          echo "  ğŸ·ï¸ Image Tag: ${{ steps.tags.outputs.IMAGE_TAG }}"
          echo "  ğŸŒ Environment: ${{ github.event.inputs.environment }}"
          echo "  ğŸ“¦ Registry: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          echo "  ğŸ”„ Commit: ${{ github.sha }}"
          echo ""
          echo "ğŸ”— ì ‘ì† ì •ë³´:"
          echo "  ğŸŒ External: https://fortinet.jclee.me"
          echo "  ğŸ”— Internal: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}"
          echo "  ğŸ¥ Health: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health"
          echo ""
          echo "ğŸ“Š GitOps ëŒ€ì‹œë³´ë“œ:"
          echo "  ğŸ”„ ArgoCD: https://${{ env.ARGOCD_SERVER }}"
          echo "  ğŸ“¦ Registry: https://registry.jclee.me"
          echo ""
          echo "ğŸ‰ GitOps ë°°í¬ ì„±ê³µ!"