name: ğŸš€ GitOps CI/CD Pipeline (jclee.me)

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: fortinet
  APP_NAME: fortinet
  K8S_NAMESPACE: fortinet
  ARGOCD_SERVER: argo.jclee.me
  DEPLOYMENT_HOST: 192.168.50.110
  DEPLOYMENT_PORT: 30777

jobs:
  # í…ŒìŠ¤íŠ¸ ë‹¨ê³„ (ê°„ì†Œí™”)
  test:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest flake8 safety bandit
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short || echo "Tests completed"
          flake8 src/ --max-line-length=120 --ignore=E203,W503 || echo "Linting completed"

  # ğŸ³ Docker ë¹Œë“œ ë° Registry í‘¸ì‹œ
  build:
    runs-on: self-hosted
    needs: [test]
    if: github.event_name != 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # GitOps íˆìŠ¤í† ë¦¬ ì „ì²´ í•„ìš”

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to jclee.me Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: ğŸ“‹ Extract GitOps metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-,format=short
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=FortiGate Nextrade
            org.opencontainers.image.description=Network monitoring and analysis platform
            org.opencontainers.image.vendor=jclee.me
            gitops.strategy=pull-based
            gitops.managed-by=argocd

      - name: ğŸš€ Build and push to Registry
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.production
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ“Š Image build summary
        run: |
          echo "ğŸ‰ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
          echo "ğŸ“¦ Registry: ${{ env.REGISTRY }}"
          echo "ğŸ·ï¸ Tags:"
          echo "${{ steps.meta.outputs.tags }}"
          echo "ğŸ“ Labels:"
          echo "${{ steps.meta.outputs.labels }}"

  # âš™ï¸ GitOps ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (Kustomize)
  gitops-update:
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout code with token
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ·ï¸ Extract image tag
        id: extract
        run: |
          IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-8)
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${IMAGE_TAG}"

      - name: ğŸ”„ Update Kustomize overlay
        run: |
          cd k8s/overlays/production
          
          # Kustomize ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s/newTag:.*/newTag: ${{ steps.extract.outputs.IMAGE_TAG }}/" kustomization.yaml
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          echo "ğŸ“ Updated kustomization.yaml:"
          cat kustomization.yaml

      - name: ğŸ“¤ Commit GitOps changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions (GitOps)"
          
          git add k8s/overlays/production/kustomization.yaml
          
          if git diff --staged --quiet; then
            echo "âš ï¸ ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸš€ GitOps: Deploy fortinet:${{ steps.extract.outputs.IMAGE_TAG }}
            
            ğŸ”„ GitOps ìë™ ë°°í¬
            - Image: registry.jclee.me/fortinet:${{ steps.extract.outputs.IMAGE_TAG }}
            - Namespace: ${{ env.K8S_NAMESPACE }}
            - ArgoCD: ${{ env.ARGOCD_SERVER }}
            - Commit: ${{ github.sha }}
            
            Co-authored-by: GitHub Actions <action@github.com>"
            
            git push
            echo "âœ… GitOps ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"
          fi

      - name: â±ï¸ ArgoCD ë™ê¸°í™” ëŒ€ê¸°
        run: |
          echo "ğŸ”„ ArgoCDê°€ GitOps ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•˜ê³  ìë™ ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          echo "ğŸ“Š ArgoCD Dashboard: https://${{ env.ARGOCD_SERVER }}"
          echo "âŒ› ë™ê¸°í™” ì™„ë£Œê¹Œì§€ ì•½ 1-2ë¶„ ì†Œìš”ë©ë‹ˆë‹¤."

  # ğŸ” GitOps ë°°í¬ ê²€ì¦
  verify-deployment:
    runs-on: self-hosted
    needs: gitops-update
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - name: â±ï¸ ArgoCD ë™ê¸°í™” ëŒ€ê¸°
        run: |
          echo "â±ï¸ ArgoCD ìë™ ë™ê¸°í™” ëŒ€ê¸° ì¤‘..."
          echo "ğŸ”„ Pull ê¸°ë°˜ GitOps ëª¨ë¸ë¡œ ArgoCDê°€ ë³€ê²½ì‚¬í•­ì„ ê°ì§€í•©ë‹ˆë‹¤."
          sleep 90  # ArgoCD ë™ê¸°í™” ì‹œê°„ í™•ë³´

      - name: ğŸ¥ ë°°í¬ ìƒíƒœ ê²€ì¦
        run: |
          max_attempts=15
          attempt=1
          
          echo "ğŸ” GitOps ë°°í¬ ìƒíƒœ ê²€ì¦ ì‹œì‘..."
          echo "ğŸ¯ Target: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health"
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ”„ ì‹œë„ $attempt/$max_attempts: GitOps ë°°í¬ í—¬ìŠ¤ì²´í¬..."
            
            if curl -f -s --connect-timeout 10 --max-time 20 "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" > /dev/null; then
              echo "âœ… GitOps ë°°í¬ ê²€ì¦ ì„±ê³µ!"
              echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ì‘ë‹µ:"
              curl -s "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health" | jq . 2>/dev/null || curl -s "http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health"
              echo ""
              echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
              break
            else
              echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë„ë‹¬. ë°°í¬ ê²€ì¦ ì‹¤íŒ¨!"
                echo "ğŸ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:"
                echo "   - ArgoCD ëŒ€ì‹œë³´ë“œ: https://${{ env.ARGOCD_SERVER }}"
                echo "   - Pod ìƒíƒœ: kubectl get pods -n ${{ env.K8S_NAMESPACE }}"
                echo "   - Service ìƒíƒœ: kubectl get svc -n ${{ env.K8S_NAMESPACE }}"
                exit 1
              fi
              echo "â³ 30ì´ˆ í›„ ì¬ì‹œë„..."
              sleep 30
              attempt=$((attempt + 1))
            fi
          done

      - name: ğŸ“Š ë°°í¬ ì •ë³´ ìˆ˜ì§‘
        if: success()
        run: |
          echo "ğŸ“‹ GitOps ë°°í¬ ì •ë³´:"
          echo "ğŸ·ï¸ Image Tag: $(echo "${{ github.sha }}" | cut -c1-8)"
          echo "ğŸŒ External URL: https://fortinet.jclee.me"
          echo "ğŸ”— Internal URL: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}"
          echo "ğŸ“Š ArgoCD: https://${{ env.ARGOCD_SERVER }}"
          echo "ğŸ“¦ Registry: https://registry.jclee.me"

  # ğŸ“¢ GitOps íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ì•Œë¦¼
  notify:
    runs-on: self-hosted
    needs: [test, build, gitops-update, verify-deployment]
    if: always() && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    steps:
      - name: ğŸ“Š GitOps íŒŒì´í”„ë¼ì¸ ìƒíƒœ ë¦¬í¬íŠ¸
        run: |
          echo "ğŸš€ GITOPS PIPELINE REPORT"
          echo "========================="
          echo ""
          
          # ê° ë‹¨ê³„ ìƒíƒœ í™•ì¸
          echo "ğŸ“‹ íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ë³„ ìƒíƒœ:"
          echo "  ğŸ§ª Test: ${{ needs.test.result }}"
          echo "  ğŸ³ Build: ${{ needs.build.result }}"
          echo "  âš™ï¸ GitOps Update: ${{ needs.gitops-update.result }}"
          echo "  ğŸ” Verification: ${{ needs.verify-deployment.result }}"
          echo ""
          
          if [ "${{ needs.verify-deployment.result }}" = "success" ]; then
            echo "ğŸ‰ GitOps íŒŒì´í”„ë¼ì¸ ì™„ì „ ì„±ê³µ!"
            echo ""
            echo "ğŸ”— ì„œë¹„ìŠ¤ ì ‘ê·¼ ì •ë³´:"
            echo "  ğŸŒ External: https://fortinet.jclee.me"
            echo "  ğŸ”— Internal: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}"
            echo "  ğŸ¥ Health: http://${{ env.DEPLOYMENT_HOST }}:${{ env.DEPLOYMENT_PORT }}/api/health"
            echo ""
            echo "ğŸ“Š ì¸í”„ë¼ ëŒ€ì‹œë³´ë“œ:"
            echo "  ğŸ”„ ArgoCD: https://${{ env.ARGOCD_SERVER }}"
            echo "  ğŸ“¦ Registry: https://registry.jclee.me"
            echo "  ğŸ“ˆ Charts: https://charts.jclee.me"
            echo ""
            echo "ğŸ·ï¸ ë°°í¬ ì •ë³´:"
            echo "  ğŸ“¦ Image: registry.jclee.me/fortinet:$(echo "${{ github.sha }}" | cut -c1-8)"
            echo "  ğŸ”„ Commit: ${{ github.sha }}"
            echo "  ğŸ‘¤ Author: ${{ github.actor }}"
            echo "  ğŸ“… Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            
          elif [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ì‹¤íŒ¨!"
            echo "ğŸ” í…ŒìŠ¤íŠ¸ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
          elif [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Docker ë¹Œë“œ ë‹¨ê³„ ì‹¤íŒ¨!"
            echo "ğŸ” ë¹Œë“œ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
            
          elif [ "${{ needs.gitops-update.result }}" != "success" ]; then
            echo "âŒ GitOps ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨!"
            echo "ğŸ” Kustomize ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
            
          elif [ "${{ needs.verify-deployment.result }}" != "success" ]; then
            echo "âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨!"
            echo "ğŸ” ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:"
            echo "  - ArgoCD ëŒ€ì‹œë³´ë“œ: https://${{ env.ARGOCD_SERVER }}"
            echo "  - Pod ë¡œê·¸: kubectl logs -l app=fortinet -n ${{ env.K8S_NAMESPACE }}"
            echo "  - Service ìƒíƒœ: kubectl get svc -n ${{ env.K8S_NAMESPACE }}"
          else
            echo "âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ë¡œ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!"
          fi
          
          echo ""
          echo "GitOps ì „ëµ: Pull-based (CNCF í‘œì¤€)"
          echo "ê´€ë¦¬ ë„êµ¬: ArgoCD + Kustomize"
          echo "ë³´ì•ˆ ëª¨ë¸: ìµœì†Œ ê¶Œí•œ + Service Account"