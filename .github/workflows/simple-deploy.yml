name: Simple Deploy - FortiGate Nextrade

on:
  push:
    branches: [ main, master, develop ]

env:
  REGISTRY: registry.jclee.me
  IMAGE_NAME: fortinet

jobs:
  build-and-deploy:
    name: ğŸš€ Build and Deploy
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      run: |
        # Clean workspace
        rm -rf *
        rm -rf .*
        
        # Clone repository
        git clone https://github.com/JCLEE94/fortinet.git .
        git checkout ${{ github.sha }}
        
        echo "âœ… Repository cloned successfully"
        
    - name: ğŸ³ Build Docker Image
      run: |
        echo "ğŸ³ Building Docker image..."
        
        # Build with legacy builder to avoid BuildKit issues
        export DOCKER_BUILDKIT=0
        
        docker build -f Dockerfile.production \
          --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
          --build-arg GIT_COMMIT=${{ github.sha }} \
          --build-arg GIT_BRANCH=${{ github.ref_name }} \
          --build-arg VERSION=${{ github.ref_name }}-${{ github.sha }} \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .
        
        echo "âœ… Docker image built successfully"
        
    - name: ğŸš€ Push to Registry
      run: |
        echo "ğŸš€ Pushing to registry..."
        
        # Login to registry (use existing credentials from environment)
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        echo "âœ… Images pushed to registry"
        
    - name: â˜¸ï¸ Deploy to Kubernetes
      run: |
        echo "â˜¸ï¸ Deploying to Kubernetes..."
        
        # Navigate to k8s directory
        cd k8s
        
        # Update image tag in kustomization
        sed -i "s/newTag: .*/newTag: ${{ github.sha }}/" kustomization.yaml
        
        # Apply to cluster
        kubectl apply -k . || echo "âš ï¸ Some resources may have validation warnings"
        
        # Restore kustomization file
        sed -i "s/newTag: .*/newTag: latest/" kustomization.yaml
        
        echo "âœ… Deployment applied"
        
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Waiting for deployment..."
        
        # Wait for rollout
        kubectl rollout status deployment/fortinet -n fortinet --timeout=300s || {
          echo "âš ï¸ Rollout may be slow, checking pod status..."
          kubectl get pods -n fortinet -l app=fortinet
        }
        
        # Health check with retry
        for i in {1..10}; do
          sleep 30
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://fortinet.jclee.me/api/health || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Health check passed! Application is running."
            
            # Verify deployed version
            HEALTH=$(curl -s https://fortinet.jclee.me/api/health || echo "{}")
            echo "ğŸ“Š Health Response: $HEALTH"
            
            exit 0
          else
            echo "â³ Attempt $i: Health check failed (HTTP $HTTP_CODE), retrying..."
          fi
        done
        
        echo "âŒ Health check failed after 10 attempts"
        kubectl get pods -n fortinet -l app=fortinet
        exit 1
        
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "===================="
        echo "ğŸ·ï¸ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ³ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo "ğŸŒ URL: https://fortinet.jclee.me"
        echo "ğŸ“… Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""
        
        # Show current pods
        echo "ğŸ“¦ Current Pods:"
        kubectl get pods -n fortinet -l app=fortinet
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deployment completed successfully!"
        else
          echo "âŒ Deployment failed!"
        fi