name: CI/CD Pipeline - FortiGate Nextrade

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  REGISTRY: ${{ vars.DOCKER_REGISTRY || 'registry.jclee.me' }}
  IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME || 'fortinet' }}
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION || '3.11' }}

jobs:
  test:
    name: ğŸ§ª Tests & Code Quality
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Install dependencies
      run: |
        # Force reinstall pip
        curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
        python get-pip.py --force-reinstall
        rm get-pip.py
        
        # Upgrade pip and setuptools
        python -m pip install --upgrade pip setuptools wheel
        
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        pip install pytest pytest-cov flake8 black isort mypy
        
    - name: ğŸ” Code Quality Checks
      run: |
        echo "ğŸ” Running code quality checks..."
        
        # Code formatting check (non-blocking)
        black --check src/ || echo "âŒ Black formatting issues found"
        
        # Import sorting check (non-blocking)
        isort --check-only src/ || echo "âŒ Import sorting issues found"
        
        # Linting (non-blocking)
        flake8 src/ --max-line-length=120 --ignore=E203,W503 || echo "âŒ Flake8 issues found"
        
        # Type checking (non-blocking)
        mypy src/ --ignore-missing-imports || echo "âš ï¸ Type checking issues found"
        
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running test suite..."
        cd src
        python -m pytest ../tests/ --cov=. --cov-report=xml --cov-report=html -v || echo "âš ï¸ Some tests failed"

  security:
    name: ğŸ”’ Security Scan
    runs-on: self-hosted
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Run Security Scan
      run: |
        echo "ğŸ”’ Running security scans..."
        
        # Install security tools
        pip install safety bandit || echo "Security tools installation failed"
        
        # Check for known vulnerabilities (non-blocking)
        safety check || echo "âš ï¸ Security vulnerabilities found"
        
        # Code security analysis (non-blocking)
        bandit -r src/ || echo "âš ï¸ Security issues found"
        
        # Check for hardcoded secrets
        echo "ğŸ” Checking for hardcoded secrets..."
        if grep -r -i "password\|secret\|key" src/ --include="*.py" | grep -v "getenv\|environ\|example\|template"; then
          echo "âš ï¸ Potential hardcoded secrets found"
        else
          echo "âœ… No hardcoded secrets found"
        fi

  build:
    name: ğŸ³ Build & Push Docker Image
    runs-on: self-hosted
    needs: [test, security]
    if: github.event_name == 'push'
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Log in to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        
    - name: ğŸ” Log in to Private Registry
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin
        
    - name: ğŸš€ Build and Push
      run: |
        # Build image
        docker build -f Dockerfile.production \
          --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
          --build-arg GIT_COMMIT=${{ github.sha }} \
          --build-arg GIT_BRANCH=${{ github.ref_name }} \
          --build-arg VERSION=latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
          -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          .
        
        # Push images
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          
    - name: ğŸ¯ Deployment Ready
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "ğŸš€ Docker image built and pushed successfully!"
        echo "ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ“¦ SHA: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
        echo ""
        echo "ğŸ”„ Image ready for deployment..."
        echo "Registry: ${{ env.REGISTRY }}"
        echo ""
        echo "âœ… CI/CD Build completed successfully!"

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: self-hosted
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ğŸ”” Trigger Watchtower Update
      id: watchtower
      run: |
        echo "ğŸ”” Triggering Watchtower to update containers..."
        
        # Trigger Watchtower webhook
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
          -H "Authorization: Bearer MySuperSecretToken12345" \
          https://watchtower.jclee.me/v1/update)
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
          echo "âœ… Watchtower update triggered successfully!"
          echo "Response: $BODY"
        else
          echo "âš ï¸ Failed to trigger Watchtower update (HTTP $HTTP_CODE)"
          echo "Response: $BODY"
          echo "Note: Manual deployment may be required"
        fi
        
    - name: â±ï¸ Wait for Deployment
      run: |
        echo "â±ï¸ Waiting for deployment to complete..."
        sleep 30
        
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Checking production health..."
        
        # Check health endpoint
        for i in {1..10}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://fortinet.jclee.me/api/health || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Production health check passed!"
            
            # Get detailed health info
            HEALTH=$(curl -s https://fortinet.jclee.me/api/health)
            echo "Health Response: $HEALTH"
            
            # Check if the deployed version matches
            DEPLOYED_SHA=$(echo "$HEALTH" | grep -o '"git_commit":"[^"]*"' | cut -d'"' -f4 || echo "unknown")
            if [ "$DEPLOYED_SHA" = "${{ github.sha }}" ]; then
              echo "âœ… Correct version deployed: $DEPLOYED_SHA"
            else
              echo "âš ï¸ Version mismatch - Expected: ${{ github.sha }}, Found: $DEPLOYED_SHA"
            fi
            
            break
          else
            echo "â³ Health check attempt $i failed (HTTP $HTTP_CODE), retrying in 10s..."
            sleep 10
          fi
        done
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "âš ï¸ Production health check failed after 10 attempts"
          echo "Note: Server may need manual verification"
        fi
        
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "ğŸ“Š Deployment Summary"
        echo "===================="
        echo "ğŸ·ï¸ Version: ${{ github.sha }}"
        echo "ğŸ“¦ Image: ${{ needs.build.outputs.image-tag }}"
        echo "ğŸŒ URL: https://fortinet.jclee.me"
        echo "ğŸ“… Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""
        if [ "${{ steps.watchtower.outcome }}" = "success" ]; then
          echo "âœ… Deployment completed successfully!"
        else
          echo "âŒ Deployment failed!"
        fi