name: ğŸ“¦ Dependency Update Automation

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)
    - cron: '0 0 * * 1'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Python ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
  update-python-deps:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools pipdeptree

      - name: ğŸ” Check for outdated packages
        run: |
          echo "ğŸ“‹ í˜„ì¬ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€:"
          pip list --outdated --format=json > outdated.json
          if [ -s outdated.json ]; then
            echo "âš ï¸ ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€ ë°œê²¬"
            cat outdated.json
          else
            echo "âœ… ëª¨ë“  íŒ¨í‚¤ì§€ê°€ ìµœì‹  ë²„ì „"
          fi

      - name: ğŸ“ Generate requirements.txt from pyproject.toml
        if: hashFiles('pyproject.toml') != ''
        run: |
          echo "ğŸ”„ pyproject.tomlì—ì„œ requirements.txt ìƒì„±..."
          pip-compile pyproject.toml --resolver=backtracking

      - name: ğŸ”„ Update requirements.txt
        run: |
          if [ -f requirements.txt ]; then
            echo "ğŸ”„ requirements.txt ì—…ë°ì´íŠ¸ ì¤‘..."
            pip-compile requirements.txt --upgrade --resolver=backtracking
          fi

      - name: ğŸ§ª Test updated dependencies
        run: |
          echo "ğŸ§ª ì—…ë°ì´íŠ¸ëœ ì˜ì¡´ì„± í…ŒìŠ¤íŠ¸..."
          pip install -r requirements.txt
          if [ -f pyproject.toml ]; then
            pip install -e ".[test]"
          fi
          
          # ê¸°ë³¸ import í…ŒìŠ¤íŠ¸
          python -c "
          import sys
          sys.path.insert(0, 'src')
          try:
              import main
              print('âœ… ê¸°ë³¸ import í…ŒìŠ¤íŠ¸ ì„±ê³µ')
          except Exception as e:
              print(f'âŒ Import í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
              sys.exit(1)
          "

      - name: ğŸ“Š Generate dependency report
        run: |
          echo "ğŸ“Š ì˜ì¡´ì„± ë³´ê³ ì„œ ìƒì„±..."
          echo "# Dependency Update Report" > dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          
          if [ -s outdated.json ]; then
            echo "## Updated Packages" >> dependency-report.md
            python -c "
          import json
          with open('outdated.json', 'r') as f:
              data = json.load(f)
          for pkg in data:
              print(f\"- {pkg['name']}: {pkg['version']} â†’ {pkg['latest_version']}\")
          " >> dependency-report.md
          else
            echo "## No updates available" >> dependency-report.md
            echo "All packages are up to date." >> dependency-report.md
          fi

      - name: ğŸ” Security audit
        run: |
          echo "ğŸ”’ ë³´ì•ˆ ê°ì‚¬ ì‹¤í–‰..."
          pip install safety
          safety check --json > safety-report.json || echo "ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"
          
          if [ -s safety-report.json ] && [ "$(cat safety-report.json)" != "[]" ]; then
            echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬"
            cat safety-report.json
          else
            echo "âœ… ë³´ì•ˆ ì·¨ì•½ì  ì—†ìŒ"
          fi

      - name: ğŸ“¤ Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ“¦ chore: update Python dependencies
            
            - Automated dependency update
            - Security audit passed
            - Import tests passed
          title: 'ğŸ“¦ Automated Dependency Update'
          body: |
            ## ğŸ¤– Automated Dependency Update
            
            This PR contains automated updates to Python dependencies.
            
            ### Changes
            - Updated outdated packages to latest versions
            - Regenerated requirements.txt from pyproject.toml
            - Passed basic import and security tests
            
            ### Testing
            - âœ… Basic import tests passed
            - âœ… Security audit completed
            - ğŸ”„ Full CI/CD tests will run automatically
            
            ### Review Checklist
            - [ ] Review updated package versions
            - [ ] Verify no breaking changes
            - [ ] Check security audit results
            
            **Note**: This PR was automatically generated. Please review before merging.
          branch: automated/dependency-update
          delete-branch: true
          draft: false

  # Docker base image ì—…ë°ì´íŠ¸ í™•ì¸
  check-docker-updates:
    runs-on: self-hosted
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Check base image updates
        run: |
          echo "ğŸ” Docker ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í™•ì¸..."
          
          # í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë² ì´ìŠ¤ ì´ë¯¸ì§€ ì¶”ì¶œ
          base_image=$(grep "FROM python:" Dockerfile.production | head -1 | awk '{print $2}')
          echo "í˜„ì¬ ë² ì´ìŠ¤ ì´ë¯¸ì§€: $base_image"
          
          # ìµœì‹  íƒœê·¸ í™•ì¸
          echo "ğŸ“Š Python Docker ì´ë¯¸ì§€ ìµœì‹  ì •ë³´:"
          docker pull python:3.11-slim --quiet
          docker images python:3.11-slim --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}\t{{.Size}}"

      - name: ğŸ“ Create Docker update issue
        if: always()
        run: |
          echo "ğŸ“ Docker ì—…ë°ì´íŠ¸ ì •ë³´ë¥¼ ì´ìŠˆë¡œ ê¸°ë¡..."
          # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ìŠˆ ìƒì„±