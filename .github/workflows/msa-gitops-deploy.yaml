name: MSA GitOps Deployment Pipeline (jclee.me)

on:
  push:
    branches: 
      - main
      - master
      - develop
      - staging
    paths:
      - 'microservices/**'
      - 'msa-gitops/**'
      - '.github/workflows/msa-gitops-deploy.yaml'
  pull_request:
    branches: 
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - development
          - staging
          - production
      service:
        description: 'Service to deploy (all for all services)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - user-service
          - product-service
          - order-service
          - notification-service
      force_deploy:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  CHARTMUSEUM: https://charts.jclee.me
  ARGOCD_URL: https://argo.jclee.me

jobs:
  # í™˜ê²½ ë° ì„œë¹„ìŠ¤ ê²°ì •
  determine-deployment:
    runs-on: [self-hosted, jclee]
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      services: ${{ steps.env.outputs.services }}
      should-deploy: ${{ steps.env.outputs.should-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Environment and Services
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            SERVICES="${{ github.event.inputs.service }}"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref }}" = "refs/heads/main" ] || [ "${{ github.ref }}" = "refs/heads/master" ]; then
            ENVIRONMENT="production"
            SERVICES="all"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            ENVIRONMENT="staging"
            SERVICES="all"
            SHOULD_DEPLOY="true"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            ENVIRONMENT="development"
            SERVICES="all"
            SHOULD_DEPLOY="true"
          else
            ENVIRONMENT="development"
            SERVICES="all"
            SHOULD_DEPLOY="false"
          fi
          
          # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
          if [ "${SERVICES}" = "all" ] && [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_SERVICES=$(git diff --name-only HEAD~1 HEAD | grep "^microservices/" | cut -d'/' -f2 | sort -u | tr '\n' ',' | sed 's/,$//')
            if [ -n "${CHANGED_SERVICES}" ]; then
              SERVICES="${CHANGED_SERVICES}"
            fi
          fi
          
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "services=${SERVICES}" >> $GITHUB_OUTPUT
          echo "should-deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Target Environment: ${ENVIRONMENT}"
          echo "ğŸ“± Services to deploy: ${SERVICES}"
          echo "ğŸš€ Should Deploy: ${SHOULD_DEPLOY}"

  # MSA ì„œë¹„ìŠ¤ ë¹Œë“œ (ë³‘ë ¬)
  build-msa-services:
    runs-on: [self-hosted, jclee]
    needs: determine-deployment
    if: needs.determine-deployment.outputs.should-deploy == 'true'
    strategy:
      matrix:
        service: [user-service, product-service, order-service, notification-service]
    outputs:
      image-tags: ${{ steps.meta.outputs.tags }}
      chart-version: ${{ steps.version.outputs.chart-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if service changed
        id: changes
        run: |
          if [ "${{ needs.determine-deployment.outputs.services }}" = "all" ]; then
            echo "build=true" >> $GITHUB_OUTPUT
          elif echo "${{ needs.determine-deployment.outputs.services }}" | grep -q "${{ matrix.service }}"; then
            echo "build=true" >> $GITHUB_OUTPUT
          else
            echo "build=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        if: steps.changes.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        if: steps.changes.outputs.build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: admin
          password: bingogo1

      - name: Generate version
        if: steps.changes.outputs.build == 'true'
        id: version
        run: |
          COMMIT_SHA="${{ github.sha }}"
          BRANCH_NAME="${{ github.ref_name }}"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          CHART_VERSION="1.0.0-${COMMIT_SHA:0:8}-${TIMESTAMP}"
          echo "chart-version=${CHART_VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Chart Version: ${CHART_VERSION}"

      - name: Extract metadata
        if: steps.changes.outputs.build == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/jclee/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-,enable={{is_default_branch}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ needs.determine-deployment.outputs.environment }}

      - name: Build and push Docker image
        if: steps.changes.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./microservices/${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/jclee/${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/jclee/${{ matrix.service }}:buildcache,mode=max

      - name: Package Helm Chart
        if: steps.changes.outputs.build == 'true'
        run: |
          if [ -d "charts/${{ matrix.service }}" ]; then
            echo "ğŸ“Š Helm Chart íŒ¨í‚¤ì§•: ${{ matrix.service }}"
            
            # Chart ë²„ì „ ì—…ë°ì´íŠ¸
            sed -i "s/^version:.*/version: ${{ steps.version.outputs.chart-version }}/" charts/${{ matrix.service }}/Chart.yaml
            sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.chart-version }}\"/" charts/${{ matrix.service }}/Chart.yaml
            
            # Chart íŒ¨í‚¤ì§•
            helm package charts/${{ matrix.service }} --destination ./
            
            # ChartMuseum ì—…ë¡œë“œ
            CHART_FILE="${{ matrix.service }}-${{ steps.version.outputs.chart-version }}.tgz"
            echo "ğŸ“¤ ChartMuseum ì—…ë¡œë“œ: ${CHART_FILE}"
            
            HTTP_CODE=$(curl -w "%{http_code}" -s -o /tmp/upload_response.txt \
              -u admin:bingogo1 \
              --data-binary "@${CHART_FILE}" \
              ${{ env.CHARTMUSEUM }}/api/charts)
            
            if [ "${HTTP_CODE}" = "201" ] || [ "${HTTP_CODE}" = "409" ]; then
              echo "âœ… Chart ì—…ë¡œë“œ ì„±ê³µ: ${{ matrix.service }}"
            else
              echo "âŒ Chart ì—…ë¡œë“œ ì‹¤íŒ¨ (HTTP ${HTTP_CODE})"
              cat /tmp/upload_response.txt
              exit 1
            fi
          fi

  # MSA GitOps ë°°í¬
  msa-gitops-deploy:
    runs-on: [self-hosted, jclee]
    needs: [determine-deployment, build-msa-services]
    environment: ${{ needs.determine-deployment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Setup ArgoCD CLI
        run: |
          if ! command -v argocd &> /dev/null; then
            curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            sudo install -m 555 argocd /usr/local/bin/argocd
            rm argocd
          fi
          argocd version --client

      - name: MSA GitOps Deployment
        env:
          ENVIRONMENT: ${{ needs.determine-deployment.outputs.environment }}
          SERVICES: ${{ needs.determine-deployment.outputs.services }}
          CHART_VERSION: ${{ needs.build-msa-services.outputs.chart-version }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -e
          
          echo "ğŸš€ MSA GitOps ë°°í¬ ì‹œì‘..."
          echo "  - Environment: ${ENVIRONMENT}"
          echo "  - Services: ${SERVICES}"
          echo "  - Chart Version: ${CHART_VERSION}"
          echo "  - Image Tag: ${IMAGE_TAG}"
          
          # ArgoCD ë¡œê·¸ì¸
          echo "ğŸ” ArgoCD ë¡œê·¸ì¸..."
          argocd login argo.jclee.me --username admin --password bingogo1 --insecure --grpc-web
          
          # í™˜ê²½ë³„ ì„¤ì •
          case ${ENVIRONMENT} in
            "development")
              NAMESPACE="microservices-dev"
              DOMAIN_SUFFIX="-dev.jclee.me"
              REPLICA_COUNT=1
              ;;
            "staging")
              NAMESPACE="microservices-staging"
              DOMAIN_SUFFIX="-staging.jclee.me"
              REPLICA_COUNT=2
              ;;
            "production")
              NAMESPACE="microservices"
              DOMAIN_SUFFIX=".jclee.me"
              REPLICA_COUNT=3
              ;;
          esac
          
          # MSA ì„œë¹„ìŠ¤ ëª©ë¡
          MSA_SERVICES=("user-service" "product-service" "order-service" "notification-service")
          
          # ì¸í”„ë¼ ì»´í¬ë„ŒíŠ¸ ë°°í¬
          echo "ğŸ—ï¸ ì¸í”„ë¼ ì»´í¬ë„ŒíŠ¸ í™•ì¸/ë°°í¬..."
          
          # Istio ë°°í¬
          envsubst < msa-gitops/applications/istio-application.yaml > /tmp/istio-${ENVIRONMENT}.yaml
          argocd app create -f /tmp/istio-${ENVIRONMENT}.yaml --upsert || true
          argocd app sync istio-${ENVIRONMENT} --timeout 300 || true
          
          # Monitoring ë°°í¬
          envsubst < msa-gitops/applications/monitoring-application.yaml > /tmp/monitoring-${ENVIRONMENT}.yaml
          argocd app create -f /tmp/monitoring-${ENVIRONMENT}.yaml --upsert || true
          argocd app sync monitoring-${ENVIRONMENT} --timeout 300 || true
          
          # ë°°í¬í•  ì„œë¹„ìŠ¤ ê²°ì •
          if [ "${SERVICES}" = "all" ]; then
            SERVICES_TO_DEPLOY=("${MSA_SERVICES[@]}")
          else
            IFS=',' read -ra SERVICES_TO_DEPLOY <<< "${SERVICES}"
          fi
          
          # MSA ì„œë¹„ìŠ¤ ë°°í¬
          for SVC in "${SERVICES_TO_DEPLOY[@]}"; do
            echo "ğŸ“± MSA ì„œë¹„ìŠ¤ ë°°í¬: ${SVC}"
            
            # Application YAML ìƒì„±
            envsubst < msa-gitops/applications/${SVC}-application.yaml > /tmp/${SVC}-${ENVIRONMENT}.yaml
            
            # ArgoCD Application ìƒì„±/ì—…ë°ì´íŠ¸
            argocd app create -f /tmp/${SVC}-${ENVIRONMENT}.yaml --upsert
            
            # ë™ê¸°í™” ì‹¤í–‰
            echo "ğŸ”„ ArgoCD ë™ê¸°í™” ì‹¤í–‰: ${SVC}-${ENVIRONMENT}"
            argocd app sync ${SVC}-${ENVIRONMENT} --timeout 300
            
            # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
            echo "â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸°: ${SVC}-${ENVIRONMENT}"
            argocd app wait ${SVC}-${ENVIRONMENT} --timeout 300
          done
          
          # ì „ì²´ MSA ìƒíƒœ í™•ì¸
          echo "ğŸ“Š MSA ì „ì²´ ìƒíƒœ í™•ì¸..."
          for SVC in "${SERVICES_TO_DEPLOY[@]}"; do
            STATUS=$(argocd app get ${SVC}-${ENVIRONMENT} -o json | jq -r '.status.health.status')
            echo "  ğŸ“± ${SVC}: ${STATUS}"
          done
          
          echo "ğŸ‰ MSA GitOps ë°°í¬ ì™„ë£Œ!"
          echo ""
          echo "ğŸŒ MSA ì„œë¹„ìŠ¤ URLs:"
          for SVC in "${SERVICES_TO_DEPLOY[@]}"; do
            echo "  - ${SVC}: https://${SVC}${DOMAIN_SUFFIX}"
          done
          echo ""
          echo "ğŸ“Š ëª¨ë‹ˆí„°ë§:"
          echo "  - ArgoCD: https://argo.jclee.me/applications"
          echo "  - Grafana: https://grafana${DOMAIN_SUFFIX}"
          echo "  - K8s Dashboard: https://k8s.jclee.me"

  # MSA ë°°í¬ ê²€ì¦
  verify-msa-deployment:
    runs-on: [self-hosted, jclee]
    needs: [determine-deployment, msa-gitops-deploy]
    steps:
      - name: Verify MSA Deployment
        env:
          ENVIRONMENT: ${{ needs.determine-deployment.outputs.environment }}
          SERVICES: ${{ needs.determine-deployment.outputs.services }}
        run: |
          # í™˜ê²½ë³„ URL ì„¤ì •
          case ${ENVIRONMENT} in
            "development")
              DOMAIN_SUFFIX="-dev.jclee.me"
              ;;
            "staging") 
              DOMAIN_SUFFIX="-staging.jclee.me"
              ;;
            "production")
              DOMAIN_SUFFIX=".jclee.me"
              ;;
          esac
          
          echo "ğŸ” MSA ë°°í¬ ê²€ì¦ ì‹œì‘..."
          
          # ë°°í¬í•  ì„œë¹„ìŠ¤ ê²°ì •
          MSA_SERVICES=("user-service" "product-service" "order-service" "notification-service")
          if [ "${SERVICES}" = "all" ]; then
            SERVICES_TO_VERIFY=("${MSA_SERVICES[@]}")
          else
            IFS=',' read -ra SERVICES_TO_VERIFY <<< "${SERVICES}"
          fi
          
          # ê° MSA ì„œë¹„ìŠ¤ Health Check
          for SVC in "${SERVICES_TO_VERIFY[@]}"; do
            SERVICE_URL="https://${SVC}${DOMAIN_SUFFIX}"
            echo "ğŸ” ê²€ì¦ ì¤‘: ${SERVICE_URL}"
            
            # Health Check (ìµœëŒ€ 10ë¶„ ëŒ€ê¸°)
            for i in {1..20}; do
              if curl -f -s ${SERVICE_URL}/health > /dev/null 2>&1; then
                echo "âœ… Health Check ì„±ê³µ: ${SVC}"
                break
              else
                echo "â³ Health Check ëŒ€ê¸° ì¤‘: ${SVC} ($i/20)"
                sleep 30
              fi
            done
            
            # API Endpoint í…ŒìŠ¤íŠ¸
            curl -f ${SERVICE_URL}/api/v1/health || echo "âš  API Health Check ì‹¤íŒ¨: ${SVC}"
          done
          
          echo "ğŸ¯ MSA ë°°í¬ ê²€ì¦ ì™„ë£Œ!"